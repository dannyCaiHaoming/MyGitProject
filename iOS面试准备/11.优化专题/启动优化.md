# 启动优化

## 优化的过程

1. 如何监控启动的时间
2. 启动流程是怎么样的
3. 能优化的地方是哪里？为什么？要怎么做？原理是什么

## 统计时间监控

### 1. 测量哪个启动的流程

应用启动分为三种：

- 冷启动（我们就是要这个数据）
- 热启动（app在后台且存活，再次打开）
- resume(恢复) （app已经加载过进内存，而且还没有从内存挪出来，有一段时间没有用过，被系统自动停掉）

只有在冷启动的时候会比较耗费加载的时候，因此主要是优化这个阶段的耗时。



### 2. 测量流程的阶段划分

#### 2.1 pre-main阶段

- 加载`mach-o`目标格式文件

- 加载动态库，由`dyld`加载`dylib`

  - 分析app依赖的所有`dylib`
  - 找到`dylib`对应的`mach-o`文件
  - 打开读取`mach-o`文件，并验证有效性
  - 在系统内核中注册代码签名
  - 对`dylib`的每一个`segment`调用`mmap()`

- `Rebase`和`Bind`操作

  出于安全性，所以引入了`ASLR`技术(Address Space Layout Randomization)，地址空间布局随机化。需要计算地址偏移量找回正确的开始地址。`Rebase`将镜像读入内存，根据修正后的地址读取内部数据，需要消耗`IO`性能。`Bind`查询符号表，进行外部镜像绑定。

- Objc setup

  进行`Objc`的初始化，包括注册`Ojbc`类，检测`selector`唯一性，插入分类方法等

- initializers

  往应用的堆栈中写入内容，包括`+load`方法，调用`C/C++`中构造函数(attribute((constructor))修饰的，创建非基本类型的`C++`静态全局变量等。

#### 2.2 mian函数阶段

从`main函数`开始执行到`didFinishLaunchingWithOptions`方法执行结束的耗时。通常这个阶段会进行各种工具的初始化，权限申请，全局配置，设定首屏

#### 2.3 首屏渲染

首页数据准备，到首页数据刷新出来能让用户操作的时机。



### 3. 测试方法选择



#### 3.1 DEBUG测试

在Xcode的`Edit scheme` -> `Run` -> `Arguments`将环境变量`DYLD_PRINT_STATISTICS`设置为`1`。则能得到如下：

![](../images/11/pre-main时间统计.jpg)

#### 3.2 使用`sysctl`获取精确应用启动时间

使用`sysctl`提供的方法，获取用户点击app时刻的时间，得到最精确的开始时间，然后：

- `main函数内`获取`UIApplication`初始化之前即`pre-main`的时间
- 记录`applicationDidFinishedLaunch开始时刻的时间`即最后结束的时间，得到

![](../images/11/启动时间统计.jpg)


## 



## pre-main阶段优化

### pre-main阶段分步
1. 