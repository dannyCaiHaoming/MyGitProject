【资源下载管理器】

根据下载资源分类，分为图片还要压缩包。根据判断资源url后缀，判断是图片还是压缩包。如果图片则是使用kf进行下载以及缓存处理。如果是压缩包，则另外使用一个用Alamofire封装的下载器，以及zip的解压缩工具。可以同时给外部提供下载进度回调以及下载状态回调。

使用字典将url和（下载任务task，还有callbacks[进度回调，完成回调]）映射起来。开始前根据字典中是否存在已有的任务，如果有则只需要增加callbacks内容。否则开始新的任务，将回调和任务都加到这个字典中。需要注意的是，下载任务可能是在不同线程进行，字典又是非线程安全，因此需要使用另外的queue来管理这个字典的增删改查。创建下载任务`ResourceDownloadTaskContent`，并且对任务的下载回调，完成回调进行设置，然后由alamofire进行任务开始。





【怎么设计TableView展示】

这个应该就是类似设计一个SDWebImage，进行一下图片下载管理。因此需要设计一个WebImageManager.提供一个接口，就是根据图片URL，就能得到图片获取进度，还有图片完成回调。

WebImageManager里面需要使用一个ImageCacher图片缓存，一个ImageDownloader图片下载。分别提供一个获取的接口，以及一个下载的接口。

ImageCacher图片缓存，需要分别提供两套缓存方式，一个是直接使用NSCache，在内存中查找，一个是在本地硬盘上进行查找。大概的流程就是先进行内存查找，如果内存中存在的话，则可以直接使用这个内存中的图片信息进行返回。如果不存在的话，则需要到本地存储的地址，根据这个图片URL的md5字符串对文件名进行匹配，如果找到的话，则看看是否需要对这个获取到的图片先进行一个CGImage的解码获取，再进行写入到缓存中，然后再继续返回到查询结果。

ImageDownloader，主要就是根据URL，使用alamofire进行资源下载管理。就是生成下载任务，然后对下载任务的进度回调，完成回调进行配置。可能需要增加一个字典来存储URL在进行的任务，来统一管理URL对应的下载任务Task，还有回调，注意这个字典要保证线程安全。然后在下载完成之后，判断是否需要对图片进行解码，是否需要CGImage解码后将图片信息先存储到内存中，然后返回到下载结果。

WebImageDownloader在TableViewCell上的一些问题。

- 怎么解决重用
- 怎么保证同一个任务不会发起多次获取，或者请求。
- 怎么处理图片过大的问题
- 怎么处理缓存数据清理的策略



【怎么解决重用问题】

我从阅读SDWebImage那边了解到，倘若将所有的这些获取操作都包装成带有Cancel方法的Operation类，那么需要对当前操作的类绑定上一个关联对象，里面存储着一个hash表，key可以是当前类的字符串，值问这个封装的Operation类。那么在每次开始之前，都可以从这个类的关联对象中，找到这个hash表，因为每个cell只会对应一个属于自己的hash表，因此可以在每次开始之前都可以先cancel之前的，然后再重新开始这次的操作。



另外由于使用Kingfisher库没有提供内部这些操作，因此只能在图片获取回调里面，判断当前cell使用的图片url和回调的url判断是否一致，如果不一致则不使用。



【怎样保证任务不会多次重复发起】

使用一个字典，需要加上锁，或者使用线程保证读写安全。将下载操作的任务使用Operation封装起来，发起任务的时候加进去这个字典，在结束的时候移除。这样子能保证只会有一个URL对应一个任务。



【怎么处理图片过大的问题】

