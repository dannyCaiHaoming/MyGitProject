##### 面试题

- block的原理是怎样的？本质是什么？
- __block的作用是什么？有什么使用注意点？
- block的属性修饰词为什么是copy?使用block有哪些使用注意？
- block在修改NSMutableArray，需不需要添加__block？

### 1. block的本质

从clang命令得到编译后的源码，能看到block底层的实现是由一个`__main_block_impl_0`结构体构成。

而里面又包含`__block_impl_`,`__main_block_desc_0`,`变量`三部分组成。

![](../images/15/block的本质.awebp)

**简要记忆：**

1. block结构的实现，包含他的isa指针，还有函数实现的地址
2. block的描述. 还有存在copy，dispose函数
3. 捕获的变量



#### 1.2 变量捕获

| 类型       | 是否捕抓到block内部 | 访问方式 |
| ---------- | ------------------- | -------- |
| 局部auto   | 是                  | 值       |
| 局部static | 是                  | 指针     |
| 全局static | 否                  | 直接访问 |



#### 1.3 block类型

| block类型      | 环境                                                         |
| -------------- | ------------------------------------------------------------ |
| NSGlobalBlock  | 没有访问auto变量                                             |
| NSStackBlock   | 访问了普通auto变量，没有用`__block`声明的                    |
| NSMallockBlock | 使用了copy或者被其他地方引用了。此外即使没有被引用但是访问了`__block`变量也会被赋值到堆上。 |

