### 简介

有固定步骤，增加发现和利用每个影响目标的可能的漏洞的机会。

- 侦查
- 枚举
- 利用
- 维持访问
- 清理踪迹

如Web测试场景中，我们要尽可能识别网络、防火墙和入侵检测系统中所有可能组件。尽可能收集关于公司、网络和雇员的最大信息。



### 1. 使用Nmap扫描和识别服务

Nmap可能是世界上最广发使用的端口扫描器。可以用于识别活动主机、扫描TCP和UDP开放端口，检测防火墙，获得运行在远程主机上的服务版本，甚至是利用脚本来发现和利用漏洞。



##### 操作步骤

1. 查看地址是否能ping通，我们让 Nmap 只检查是否服务器响应 ICMP 请求（或 ping）

```shell
nmap -sn ip地址
```

2. 查看打开了那些端口服务，Nmap 会向 1000 个 TCP 端口列表发送探针

```shell
nmap ip地址
```

3. 查看正在服务的版本，并且基于它猜测操作系统

```shell
nmap -sV -O ip地址
```



##### 工作原理

Nmap是个端口扫描器，意味着它可以向一些指定IP的TCP或UDP端口发送封包，并且检查是否有响应。



##### 更多

- `-sT`:通常运行Nmap，使用SYN扫描类型。使用这个参数，强制扫描器执行完全连接扫描。
- `-Pn`:如果主机不相应ping，可以使用这个。
- `-v`:啰嗦模式。
- `-p N1,N2..`:指定端口
- `--script=script_name`:Nmap包含很多漏洞检测、扫描和识别、登录测试、命令执行、用户枚举以及其他脚本。



### 2. 识别Web应用防火墙

Web应用防火墙（WAF）是一个设备或软件，可以检查发送到Web服务器的封包，以便识别和阻止可能的恶意封包，通常基于签名或者正则表达式。

如果未检测到的WAF组织了我们的请求或者封禁了我们的IP，我们渗透测试中就要处理很多的麻烦。在进行渗透测试的时候，侦查层面必须包含检测倍WAF，IDS（入侵检测系统），IPS（入侵阻止系统）。



##### 操作步骤

1. Nmap包含了一些脚本，用于测试WAF的存在。

```bash
nmap -p 80,443 --script=http-waf-detect 192.168.56.102
```

2. 帮助我们识别waf设备

```shell
nmap -p 80,443 --script=http-waf-fingerprint ip地址
```

3. 另一款kali自带工具，wafw00f

```shell
wafw00f ip地址
```



##### 工作原理

WAF检测的原理是通过发送特定请求到服务器，之后分析响应。例如，在`http-waf-detect`的例子中，发送了一些基本的恶意封包，并对比响应，同时查找封包被阻拦、拒绝或检测到的标识。





### 3. 查看源代码

查看网页的源代码允许我们理解一些程序的逻辑，检测明显的漏洞，以及在测试时有所参考，因为我们能够在测试之前和之后比较代码，并且使用比较结果来修改我们的下一次尝试。



##### 操作步骤

1. 将一个`hidden`的文件最大值限制，改为`text`,允许在网页随意修改限制。



##### 工作原理

网页的源代码在发现漏洞和分析应用对所提供的输入的响应上非常有用。它也提供给我们关于应用内部如何工作，以及它是否使用了任何第三方库或框架的信息。



### 4. 使用Firefox分析和修改基本行为





### 5. 获取和修改cookie

Cookie是由服务器发送给浏览器（客户端）的小型信息片段，用于在本地存储一些信息，他们和特性用户相关。



##### 操作步骤

1. 修改cookie的`http-only`，将前端限制不允许访问cookie值的方式改掉。



### 6. 利用robots.txt

要想进一步侦查，我们需要弄清楚是否站点有任何页面或目录没有链接给普通用户看。例如，内容管理系统或者内部网络的登录页面。寻找类似于它的站点会极大扩大我们的测试面，并给我们一些关于应用及其结构的重要线索。

这个秘籍中，我们会使用`robots.txt`文件来发现一些文件和目录，它们可能不会链接到主应用的任何地方。



##### 步骤

1. 向服务器地址添加`robots.txt`，即能查看到不允许搜索引擎(User Agent)收录。





### 7. 使用DirBuster发现文件和文件夹

dirbuster是个工具，用于通过爆破来发现web服务器中现存文件和目录。



##### 工作原理

dirbuster是个爬虫和爆破组合，它允许页面上的所有连接，但是同时尝试可能文件的不同名称。这些名称可以保存在文件中。

- 200 OK： 文件存在并且能够读取
- 404 File not found：文件不存在
- 301 Moved permanently：到给定URL的重定向
- 401 Unauthorized：需要权限来访问文件
- 403 Forbidden：请求有效但是服务器拒绝响应



### 8. 使用cewl分析密码

侦查必须分析的层面是，分析应用、部门或过程的名称、以及其它被目标组织使用的单词。当需要设置人员相关的用户或密码的时候，这会帮助我们判断常被使用的组合。



##### 操作步骤

```shell
cewl -w 输出路径 -c -m 5 ip地址
```

- `-w` :指定输出路径
- `-c`:输出每个keyword次数
- `-m`:最小字符长度 

##### 工作原理

cewl爬取网站并提取独立单词的列表。他可以提供单词重复的次数，保存结果到文件，使用页面的元数据，以及其它？



### 9. 使用John the Ripper生成字典

允许我们对字典的单词使用规则、修改他们、以及在爆破中使用更丰富的单词列表而不用存储列表。

##### 操作步骤

1. john能输出密码候选

```shell
john --stdout --wordlist=单词列表文件
```

2. 使用特定规则

```shell
john --stdout --wordlist=单词列表文件 --rules
```

3. 输出到文件

```shell
john --stdout --wordlist=单词列表 --rules > 输出文件
```



##### 工作原理

虽然John the Ripper目标不是字典生成器，而是高效地使用单词列表来破解密码。它的特性运行我们将其用于扩展现在有的单词列表，并创建更符合现代用户所使用的的密码字典。





### 10. 使用ZAP发现文件和文件夹

OWASP ZAP（Zed Attack Proxy）是个用于 Web 安全测试的全能工具。他拥有代理、被动和主动漏洞扫描器、模糊测试器、爬虫、HTTP 请求发送器，一起一些其他的有趣特性。这个秘籍中，我们会使用最新添加的“强制浏览”，它是 ZAP 内的 DisBuster 实现。

##### 操作步骤

1. 将zap配置手动代理
2. 浏览器配置代理
3. 告诉zap使用哪个文件获取目录名称。`Tools|Options|Forced Brows`,文件路径在`/usr/share/wordlist/dirbuster/directory-list-lowercase-2.3small.txt`
4. 浏览器浏览目标地址
5. 在ZAP面板选择站点，然后访问`Attack|Forced Browse directory`

##### 工作原理

当我们配置浏览器来将ZAP用作代理的时候，它并不直接发送给服务器任何我们打算浏览页面的请求，而是发送到我们定义的地址。这里是ZAP监听的地址。之后ZAP将请求转发给服务器但是不分析任何我们发送的信息。

ZAP 的强制浏览的工作方式和 DIrBuster 相同，它接受我们所配置的字典，并向服务器发送请求，就像它尝试浏览列表中的文件那样。如果文件存在，服务器会相应地响应。如果文件不存在或不能被我们的当前用户访问，服务器会返回错误。